<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XMAS 3D Magic</title>
    <style>
        body { margin: 0; background: #010205; overflow: hidden; color: white; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; touch-action: none; }
        #loading {
            position: fixed; inset: 0; background: #010205;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
        }
        #debug-log {
            position: fixed; top: 10px; right: 10px; font-size: 10px; color: #00ff00;
            z-index: 1001; pointer-events: none; max-width: 200px;
        }
        .glass-card {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
            z-index: 100; pointer-events: none;
        }
        #video-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 120px; height: 160px; border-radius: 10px;
            overflow: hidden; border: 1px solid gold; transform: scaleX(-1);
            background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="loading">
        <div style="border: 3px solid gold; border-top: 3px solid transparent; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p id="loading-text">æ­£åœ¨åŠ è½½æ˜Ÿç³»å¼•æ“...</p>
    </div>

    <div id="debug-log"></div>

    <div id="ui" class="glass-card">
        <h2 style="margin:0; font-size: 16px; color: gold;">3D ç²’å­åœ£è¯æ ‘</h2>
        <p id="status" style="font-size: 12px; color: #00ffcc;">[ç­‰å¾…æ‰‹åŠ¿]</p>
    </div>

    <div id="video-container">
        <video id="input-video" playsinline webkit-playsinline muted autoplay></video>
    </div>

    <div id="canvas-container"></div>

    <!-- ä½¿ç”¨æ›´ç¨³å®šçš„ CDN é“¾æ¥ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // è°ƒè¯•å·¥å…·
        const debugLog = document.getElementById('debug-log');
        const log = (msg) => {
            console.log(msg);
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            debugLog.appendChild(div);
            if(debugLog.children.length > 8) debugLog.removeChild(debugLog.children[0]);
        };

        log("ç³»ç»Ÿå¯åŠ¨...");

        let scene, camera, renderer, particles, photos, star, composer;
        let handStatus = "open";
        
        // --- 1. åˆå§‹åŒ– 3D åœºæ™¯ ---
        function initThree() {
            log("åˆå§‹åŒ– 3D...");
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 20);

            renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // ç®€å•å…‰ç…§
            const light = new THREE.PointLight(0xffd700, 10, 50);
            light.position.set(0, 10, 0);
            scene.add(light);

            createParticles();
            log("3D å°±ç»ª.");
        }

        function createParticles() {
            const count = 6000;
            const geo = new THREE.BufferGeometry();
            const posTree = [];
            const posGalaxy = [];
            const current = [];
            
            for(let i=0; i<count; i++) {
                // Tree
                const rTree = (1 - i/count) * 6;
                const aTree = (i/count) * Math.PI * 20;
                posTree.push(Math.cos(aTree)*rTree, (i/count)*14 - 5, Math.sin(aTree)*rTree);
                
                // Galaxy
                const rGal = 5 + Math.random() * 15;
                const aGal = Math.random() * Math.PI * 2;
                posGalaxy.push(Math.cos(aGal)*rGal, (Math.random()-0.5)*5, Math.sin(aGal)*rGal);
                
                current.push(posGalaxy[i*3], posGalaxy[i*3+1], posGalaxy[i*3+2]);
            }

            geo.setAttribute('position', new THREE.Float32BufferAttribute(current, 3));
            particles = new THREE.Points(geo, new THREE.PointsMaterial({
                size: 0.1, color: 0x00ffcc, transparent: true, opacity: 0.8
            }));
            particles.userData = { t: posTree, g: posGalaxy };
            scene.add(particles);

            // æ˜Ÿæ˜Ÿ
            star = new THREE.Mesh(new THREE.SphereGeometry(0.5, 8, 8), new THREE.MeshBasicMaterial({color: 0xffd700}));
            star.position.y = 9;
            star.scale.set(0.01, 0.01, 0.01);
            scene.add(star);
        }

        function morph(mode) {
            const pos = particles.geometry.attributes.position;
            const target = mode === 'tree' ? particles.userData.t : particles.userData.g;
            for(let i=0; i<pos.count; i++) {
                gsap.to(pos.array, {
                    [i*3]: target[i*3], [i*3+1]: target[i*3+1], [i*3+2]: target[i*3+2],
                    duration: 1.5, ease: "power2.inOut", onUpdate: () => pos.needsUpdate = true
                });
            }
            gsap.to(star.scale, { x: mode==='tree'?1:0.01, y: mode==='tree'?1:0.01, z: mode==='tree'?1:0.01 });
        }

        // --- 2. åˆå§‹åŒ–æ‘„åƒå¤´ (é€‚é…æ‰‹æœº) ---
        async function initCamera() {
            log("è¯·æ±‚æ‘„åƒå¤´...");
            const video = document.getElementById('input-video');
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // æ‰‹æœºç«¯ä½¿ç”¨ 0 æé«˜å¸§ç‡
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(res => {
                if (res.multiHandLandmarks?.length > 0) {
                    const lm = res.multiHandLandmarks[0];
                    const isFist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y) < 0.3;
                    if(isFist && handStatus !== "fist") {
                        handStatus = "fist"; morph("tree");
                        document.getElementById('status').innerText = "âœŠ åœ£è¯æ ‘æ¨¡å¼";
                    } else if(!isFist && handStatus === "fist") {
                        handStatus = "open"; morph("galaxy");
                        document.getElementById('status').innerText = "ğŸ–ï¸ é“¶æ²³æ¨¡å¼";
                    }
                }
            });

            try {
                const cam = new Camera(video, {
                    onFrame: async () => await hands.send({ image: video }),
                    facingMode: 'user',
                    width: 480, height: 640
                });
                await cam.start();
                log("æ‘„åƒå¤´å·²å¯åŠ¨.");
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                log("æ— æ³•å¯åŠ¨æ‘„åƒå¤´: " + e.message);
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä¸º HTTPS ç¯å¢ƒå¹¶å…è®¸äº†æƒé™ã€‚");
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- 3. è¿è¡Œ ---
        function animate() {
            requestAnimationFrame(animate);
            if(particles) particles.rotation.y += 0.005;
            renderer.render(scene, camera);
        }

        // äº¤äº’å¤‡ä»½
        window.addEventListener('pointerdown', () => {
            handStatus = (handStatus === 'open') ? 'fist' : 'open';
            morph(handStatus === 'fist' ? 'tree' : 'galaxy');
            document.getElementById('status').innerText = "ç‚¹å‡»åˆ‡æ¢: " + handStatus;
        });

        initThree();
        animate();
        initCamera();

        // å…œåº•é€»è¾‘ï¼šå¦‚æœ 10 ç§’è¿˜æ²¡åŠ è½½å®Œï¼Œç›´æ¥å¼ºåˆ¶å…³é—­ Loading
        setTimeout(() => {
            if(document.getElementById('loading').style.display !== 'none') {
                log("æ£€æµ‹åˆ°åŠ è½½è¶…æ—¶ï¼Œå°è¯•ç›´æ¥è¿›å…¥...");
                document.getElementById('loading').style.display = 'none';
            }
        }, 10000);

    </script>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
</body>
</html>
